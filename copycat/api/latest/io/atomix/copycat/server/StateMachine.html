<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<!-- Generated by javadoc -->
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>StateMachine (Copycat API Reference (latest))</title>
<link rel="stylesheet" type="text/css" href="../../../../stylesheet.css" title="Style">
<script type="text/javascript" src="../../../../script.js"></script>
</head>
<body>
<script type="text/javascript"><!--
    try {
        if (location.href.indexOf('is-external=true') == -1) {
            parent.document.title="StateMachine (Copycat API Reference (latest))";
        }
    }
    catch(err) {
    }
//-->
var methods = {"i0":10,"i1":10};
var tabs = {65535:["t0","All Methods"],2:["t2","Instance Methods"],8:["t4","Concrete Methods"]};
var altColor = "altColor";
var rowColor = "rowColor";
var tableTab = "tableTab";
var activeTableTab = "activeTableTab";
</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="topNav"><a name="navbar.top">
<!--   -->
</a>
<div class="skipNav"><a href="#skip.navbar.top" title="Skip navigation links">Skip navigation links</a></div>
<a name="navbar.top.firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../../overview-summary.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="navBarCell1Rev">Class</li>
<li><a href="class-use/StateMachine.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../index-all.html">Index</a></li>
<li><a href="../../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../../io/atomix/copycat/server/Snapshottable.html" title="interface in io.atomix.copycat.server"><span class="typeNameLink">Prev&nbsp;Class</span></a></li>
<li><a href="../../../../io/atomix/copycat/server/StateMachineContext.html" title="interface in io.atomix.copycat.server"><span class="typeNameLink">Next&nbsp;Class</span></a></li>
</ul>
<ul class="navList">
<li><a href="../../../../index.html?io/atomix/copycat/server/StateMachine.html" target="_top">Frames</a></li>
<li><a href="StateMachine.html" target="_top">No&nbsp;Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_top">
<li><a href="../../../../allclasses-noframe.html">All&nbsp;Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_top");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<div>
<ul class="subNavList">
<li>Summary:&nbsp;</li>
<li>Nested&nbsp;|&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li>Constr&nbsp;|&nbsp;</li>
<li><a href="#method.summary">Method</a></li>
</ul>
<ul class="subNavList">
<li>Detail:&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li>Constr&nbsp;|&nbsp;</li>
<li><a href="#method.detail">Method</a></li>
</ul>
</div>
<a name="skip.navbar.top">
<!--   -->
</a></div>
<!-- ========= END OF TOP NAVBAR ========= -->
<!-- ======== START OF CLASS DATA ======== -->
<div class="header">
<div class="subTitle">io.atomix.copycat.server</div>
<h2 title="Class StateMachine" class="title">Class StateMachine</h2>
</div>
<div class="contentContainer">
<ul class="inheritance">
<li><a href="http://docs.oracle.com/javase/8/docs/api/java/lang/Object.html?is-external=true" title="class or interface in java.lang">java.lang.Object</a></li>
<li>
<ul class="inheritance">
<li>io.atomix.copycat.server.StateMachine</li>
</ul>
</li>
</ul>
<div class="description">
<ul class="blockList">
<li class="blockList">
<dl>
<dt>All Implemented Interfaces:</dt>
<dd><a href="http://docs.oracle.com/javase/8/docs/api/java/lang/AutoCloseable.html?is-external=true" title="class or interface in java.lang">AutoCloseable</a></dd>
</dl>
<hr>
<br>
<pre>public abstract class <span class="typeNameLabel">StateMachine</span>
extends <a href="http://docs.oracle.com/javase/8/docs/api/java/lang/Object.html?is-external=true" title="class or interface in java.lang">Object</a>
implements <a href="http://docs.oracle.com/javase/8/docs/api/java/lang/AutoCloseable.html?is-external=true" title="class or interface in java.lang">AutoCloseable</a></pre>
<div class="block">Base class for user-provided Raft state machines.
 <p>
 Users should extend this class to create a state machine for use within a <a href="../../../../io/atomix/copycat/server/CopycatServer.html" title="class in io.atomix.copycat.server"><code>CopycatServer</code></a>.
 <p>
 State machines are responsible for handling <a href="../../../../io/atomix/copycat/client/Operation.html" title="interface in io.atomix.copycat.client"><code>operations</code></a> submitted to the Raft cluster and
 filtering <a href="../../../../io/atomix/copycat/server/Commit.html" title="interface in io.atomix.copycat.server"><code>committed</code></a> operations out of the Raft log. The most important rule of state machines is
 that <em>state machines must be deterministic</em> in order to maintain Copycat's consistency guarantees. That is,
 state machines must not change their behavior based on external influences and have no side effects. Users should
 <em>never</em> use <code>System</code> time to control behavior within a state machine.
 <p>
 When <a href="../../../../io/atomix/copycat/client/Command.html" title="interface in io.atomix.copycat.client"><code>commands</code></a> and <a href="../../../../io/atomix/copycat/client/Query.html" title="interface in io.atomix.copycat.client"><code>queries</code></a> (i.e. <em>operations</em>) are submitted to the Raft cluster,
 the <a href="../../../../io/atomix/copycat/server/CopycatServer.html" title="class in io.atomix.copycat.server"><code>CopycatServer</code></a> will log and replicate them as necessary and, once complete, apply them to the configured
 state machine.
 <p>
 <b>State machine operations</b>
 <p>
 State machine operations are implemented as methods on the state machine. Operations can be automatically detected
 by the state machine during setup or can be explicitly registered by overriding the <a href="../../../../io/atomix/copycat/server/StateMachine.html#configure-io.atomix.copycat.server.StateMachineExecutor-"><code>configure(StateMachineExecutor)</code></a>
 method. Each operation method must take a single <a href="../../../../io/atomix/copycat/server/Commit.html" title="interface in io.atomix.copycat.server"><code>Commit</code></a> argument for a specific operation type.
 <pre>
   <code>
   public class MapStateMachine extends StateMachine {

     public Object put(Commit&lt;Put&gt; commit) {
       Commit&lt;Put&gt; previous = map.put(commit.operation().key(), commit);
       if (previous != null) {
         try {
           return previous.operation().value();
         } finally {
           previous.clean();
         }
       }
       return null;
     }

     public Object get(Commit&lt;Get&gt; commit) {
       try {
         Commit&lt;Put&gt; current = map.get(commit.operation().key());
         return current != null ? current.operation().value() : null;
       } finally {
         commit.close();
       }
     }
   }
   </code>
 </pre>
 When operations are applied to the state machine they're wrapped in a <a href="../../../../io/atomix/copycat/server/Commit.html" title="interface in io.atomix.copycat.server"><code>Commit</code></a> object. The commit provides the
 context of how the command or query was committed to the cluster, including the log <a href="../../../../io/atomix/copycat/server/Commit.html#index--"><code>Commit.index()</code></a>, the
 <a href="../../../../io/atomix/copycat/client/session/Session.html" title="interface in io.atomix.copycat.client.session"><code>Session</code></a> from which the operation was submitted, and the approximate wall-clock <a href="../../../../io/atomix/copycat/server/Commit.html#time--"><code>Commit.time()</code></a> at which
 the commit was written to the Raft log. Note that the commit time is guaranteed to progress monotonically, but it may
 not be representative of the progress of actual time. See the <a href="../../../../io/atomix/copycat/server/Commit.html" title="interface in io.atomix.copycat.server"><code>Commit</code></a> documentation for more information.
 <p>
 State machine operations are guaranteed to be executed in the order in which they were submitted by the client,
 always in the same thread, and thus always sequentially. State machines do not need to be thread safe, but they must
 be deterministic. That is, state machines are guaranteed to see <a href="../../../../io/atomix/copycat/client/Command.html" title="interface in io.atomix.copycat.client"><code>Command</code></a>s in the same order on all servers,
 and given the same commands in the same order, all servers' state machines should arrive at the same state with the
 same output (return value). The return value of each operation callback is the response value that will be sent back
 to the client.
 <p>
 <b>Deterministic scheduling</b>
 <p>
 The <a href="../../../../io/atomix/copycat/server/StateMachineExecutor.html" title="interface in io.atomix.copycat.server"><code>StateMachineExecutor</code></a> is responsible for executing state machine operations sequentially and provides an
 interface similar to that of <a href="http://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ScheduledExecutorService.html?is-external=true" title="class or interface in java.util.concurrent"><code>ScheduledExecutorService</code></a> to allow state machines to schedule
 time-based callbacks. Because of the determinism requirement, scheduled callbacks are guaranteed to be executed
 deterministically as well. The executor can be accessed via the <a href="../../../../io/atomix/copycat/server/StateMachine.html#executor--"><code>executor()</code></a> accessor method.
 See the <a href="../../../../io/atomix/copycat/server/StateMachineExecutor.html" title="interface in io.atomix.copycat.server"><code>StateMachineExecutor</code></a> documentation for more information.
 <pre>
   <code>
   public void putWithTtl(Commit&lt;PutWithTtl&gt; commit) {
     map.put(commit.operation().key(), commit);
     executor.schedule(Duration.ofMillis(commit.operation().ttl()), () -&gt; {
       map.remove(commit.operation().key()).clean();
     });
   }
   </code>
 </pre>
 <p>
 During command or scheduled callbacks, <a href="../../../../io/atomix/copycat/server/session/Sessions.html" title="interface in io.atomix.copycat.server.session"><code>Sessions</code></a> can be used to send state machine events back to the client.
 For instance, a lock state machine might use a client's <a href="../../../../io/atomix/copycat/client/session/Session.html" title="interface in io.atomix.copycat.client.session"><code>Session</code></a> to send a lock event to the client.
 <pre>
   <code>
   public void unlock(Commit&lt;Unlock&gt; commit) {
     try {
       Commit&lt;Lock&gt; next = queue.poll();
       if (next != null) {
         next.session().publish("lock");
       }
     } finally {
       commit.clean();
     }
   }
   </code>
 </pre>
 Attempts to <a href="../../../../io/atomix/copycat/client/session/Session.html#publish-java.lang.String-java.lang.Object-"><code>publish</code></a> events during the execution will result in an
 <a href="http://docs.oracle.com/javase/8/docs/api/java/lang/IllegalStateException.html?is-external=true" title="class or interface in java.lang"><code>IllegalStateException</code></a>.
 <p>
 As with other operations, state machines should ensure that the publishing of session events is deterministic.
 Messages published via a <a href="../../../../io/atomix/copycat/client/session/Session.html" title="interface in io.atomix.copycat.client.session"><code>Session</code></a> will be managed according to the <code>Command.ConsistencyLevel</code>
 of the command being executed at the time the event was <a href="../../../../io/atomix/copycat/client/session/Session.html#publish-java.lang.String-java.lang.Object-"><code>published</code></a>. Each command may
 publish zero or many events. For events published during the execution of a <code>Command.ConsistencyLevel#LINEARIZABLE</code>
 command, the state machine executor will transparently await responses from the client(s) before completing the command.
 For commands with lower consistency levels, command responses will be immediately sent. Session events are always guaranteed
 to be received by the client in the order in which they were published by the state machine.
 <p>
 Even though state machines on multiple servers may appear to publish the same event, Copycat's protocol ensures that only
 one server ever actually sends the event. Still, it's critical that all state machines publish all events to ensure
 consistency and fault tolerance. In the event that a server fails after publishing a session event, the client will transparently
 reconnect to another server and retrieve lost event messages.
 <p>
 <b>Cleaning commits</b>
 <p>
 As operations are logged, replicated, committed, and applied to the state machine, the underlying
 <a href="../../../../io/atomix/copycat/server/storage/Log.html" title="class in io.atomix.copycat.server.storage"><code>Log</code></a> grows. Without freeing unnecessary commits from the log it would eventually
 consume all available disk or memory. Copycat uses a log cleaning algorithm to remove <a href="../../../../io/atomix/copycat/server/Commit.html" title="interface in io.atomix.copycat.server"><code>Commit</code></a>s that no longer
 contribute to the state machine's state from the log. To aid in this process, it's the responsibility of state machine
 implementations to indicate when each commit is no longer needed by calling <a href="../../../../io/atomix/copycat/server/Commit.html#clean--"><code>Commit.clean()</code></a>.
 <p>
 State machines should hold on to the <a href="../../../../io/atomix/copycat/server/Commit.html" title="interface in io.atomix.copycat.server"><code>Commit</code></a> object passed to operation callbacks for as long as the commit
 contributes to the state machine's state. Once a commit is no longer needed, <a href="../../../../io/atomix/copycat/client/Query.html" title="interface in io.atomix.copycat.client"><code>Query</code></a> commits should be
 <a href="../../../../io/atomix/copycat/server/Commit.html#close--"><code>closed</code></a> and <a href="../../../../io/atomix/copycat/client/Command.html" title="interface in io.atomix.copycat.client"><code>Command</code></a> commits should be <a href="../../../../io/atomix/copycat/server/Commit.html#clean--"><code>cleaned</code></a>. Cleaning notifies
 the log compaction algorithm that it's safe to remove the commit from the internal commit log. Copycat will guarantee
 that <a href="../../../../io/atomix/copycat/server/Commit.html" title="interface in io.atomix.copycat.server"><code>Commit</code></a>s are persisted in the underlying <a href="../../../../io/atomix/copycat/server/storage/Log.html" title="class in io.atomix.copycat.server.storage"><code>Log</code></a> as long as is
 necessary (even after a commit is cleaned) to ensure all operations are applied to a majority of servers and to
 guarantee delivery of <a href="../../../../io/atomix/copycat/client/session/Session.html#publish-java.lang.String-java.lang.Object-"><code>session events</code></a> published as a result of specific
 operations. State machines only need to specify when it's safe to remove each commit from the log.
 <p>
 Note that if commits are not properly cleaned from the log and are instead garbage collected, a warning will be logged.
 Failure to <a href="../../../../io/atomix/copycat/server/Commit.html#clean--"><code>Commit.clean()</code></a> a <a href="../../../../io/atomix/copycat/client/Command.html" title="interface in io.atomix.copycat.client"><code>Command</code></a> commit from the log should be considered a critical bug since
 instances of the command can eventually fill up disk.</div>
<dl>
<dt><span class="simpleTagLabel">Author:</span></dt>
<dd><a href="http://github.com/kuujo">Jordan Halterman</a></dd>
<dt><span class="seeLabel">See Also:</span></dt>
<dd><a href="../../../../io/atomix/copycat/server/Commit.html" title="interface in io.atomix.copycat.server"><code>Commit</code></a>, 
<a href="../../../../io/atomix/copycat/client/Command.html" title="interface in io.atomix.copycat.client"><code>Command</code></a>, 
<a href="../../../../io/atomix/copycat/server/StateMachineContext.html" title="interface in io.atomix.copycat.server"><code>StateMachineContext</code></a>, 
<a href="../../../../io/atomix/copycat/server/StateMachineExecutor.html" title="interface in io.atomix.copycat.server"><code>StateMachineExecutor</code></a></dd>
</dl>
</li>
</ul>
</div>
<div class="summary">
<ul class="blockList">
<li class="blockList">
<!-- ========== METHOD SUMMARY =========== -->
<ul class="blockList">
<li class="blockList"><a name="method.summary">
<!--   -->
</a>
<h3>Method Summary</h3>
<table class="memberSummary" border="0" cellpadding="3" cellspacing="0" summary="Method Summary table, listing methods, and an explanation">
<caption><span id="t0" class="activeTableTab"><span>All Methods</span><span class="tabEnd">&nbsp;</span></span><span id="t2" class="tableTab"><span><a href="javascript:show(2);">Instance Methods</a></span><span class="tabEnd">&nbsp;</span></span><span id="t4" class="tableTab"><span><a href="javascript:show(8);">Concrete Methods</a></span><span class="tabEnd">&nbsp;</span></span></caption>
<tr>
<th class="colFirst" scope="col">Modifier and Type</th>
<th class="colLast" scope="col">Method and Description</th>
</tr>
<tr id="i0" class="altColor">
<td class="colFirst"><code>void</code></td>
<td class="colLast"><code><span class="memberNameLink"><a href="../../../../io/atomix/copycat/server/StateMachine.html#close--">close</a></span>()</code>
<div class="block">Closes the state machine.</div>
</td>
</tr>
<tr id="i1" class="rowColor">
<td class="colFirst"><code>void</code></td>
<td class="colLast"><code><span class="memberNameLink"><a href="../../../../io/atomix/copycat/server/StateMachine.html#init-io.atomix.copycat.server.StateMachineExecutor-">init</a></span>(<a href="../../../../io/atomix/copycat/server/StateMachineExecutor.html" title="interface in io.atomix.copycat.server">StateMachineExecutor</a>&nbsp;executor)</code>
<div class="block">Initializes the state machine.</div>
</td>
</tr>
</table>
<ul class="blockList">
<li class="blockList"><a name="methods.inherited.from.class.java.lang.Object">
<!--   -->
</a>
<h3>Methods inherited from class&nbsp;java.lang.<a href="http://docs.oracle.com/javase/8/docs/api/java/lang/Object.html?is-external=true" title="class or interface in java.lang">Object</a></h3>
<code><a href="http://docs.oracle.com/javase/8/docs/api/java/lang/Object.html?is-external=true#equals-java.lang.Object-" title="class or interface in java.lang">equals</a>, <a href="http://docs.oracle.com/javase/8/docs/api/java/lang/Object.html?is-external=true#getClass--" title="class or interface in java.lang">getClass</a>, <a href="http://docs.oracle.com/javase/8/docs/api/java/lang/Object.html?is-external=true#hashCode--" title="class or interface in java.lang">hashCode</a>, <a href="http://docs.oracle.com/javase/8/docs/api/java/lang/Object.html?is-external=true#notify--" title="class or interface in java.lang">notify</a>, <a href="http://docs.oracle.com/javase/8/docs/api/java/lang/Object.html?is-external=true#notifyAll--" title="class or interface in java.lang">notifyAll</a>, <a href="http://docs.oracle.com/javase/8/docs/api/java/lang/Object.html?is-external=true#toString--" title="class or interface in java.lang">toString</a>, <a href="http://docs.oracle.com/javase/8/docs/api/java/lang/Object.html?is-external=true#wait--" title="class or interface in java.lang">wait</a>, <a href="http://docs.oracle.com/javase/8/docs/api/java/lang/Object.html?is-external=true#wait-long-" title="class or interface in java.lang">wait</a>, <a href="http://docs.oracle.com/javase/8/docs/api/java/lang/Object.html?is-external=true#wait-long-int-" title="class or interface in java.lang">wait</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="details">
<ul class="blockList">
<li class="blockList">
<!-- ============ METHOD DETAIL ========== -->
<ul class="blockList">
<li class="blockList"><a name="method.detail">
<!--   -->
</a>
<h3>Method Detail</h3>
<a name="init-io.atomix.copycat.server.StateMachineExecutor-">
<!--   -->
</a>
<ul class="blockList">
<li class="blockList">
<h4>init</h4>
<pre>public&nbsp;void&nbsp;init(<a href="../../../../io/atomix/copycat/server/StateMachineExecutor.html" title="interface in io.atomix.copycat.server">StateMachineExecutor</a>&nbsp;executor)</pre>
<div class="block">Initializes the state machine.</div>
<dl>
<dt><span class="paramLabel">Parameters:</span></dt>
<dd><code>executor</code> - The state machine executor.</dd>
<dt><span class="throwsLabel">Throws:</span></dt>
<dd><code><a href="http://docs.oracle.com/javase/8/docs/api/java/lang/NullPointerException.html?is-external=true" title="class or interface in java.lang">NullPointerException</a></code> - if <code>context</code> is null</dd>
</dl>
</li>
</ul>
<a name="close--">
<!--   -->
</a>
<ul class="blockListLast">
<li class="blockList">
<h4>close</h4>
<pre>public&nbsp;void&nbsp;close()</pre>
<div class="block">Closes the state machine.</div>
<dl>
<dt><span class="overrideSpecifyLabel">Specified by:</span></dt>
<dd><code><a href="http://docs.oracle.com/javase/8/docs/api/java/lang/AutoCloseable.html?is-external=true#close--" title="class or interface in java.lang">close</a></code>&nbsp;in interface&nbsp;<code><a href="http://docs.oracle.com/javase/8/docs/api/java/lang/AutoCloseable.html?is-external=true" title="class or interface in java.lang">AutoCloseable</a></code></dd>
</dl>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<!-- ========= END OF CLASS DATA ========= -->
<!-- ======= START OF BOTTOM NAVBAR ====== -->
<div class="bottomNav"><a name="navbar.bottom">
<!--   -->
</a>
<div class="skipNav"><a href="#skip.navbar.bottom" title="Skip navigation links">Skip navigation links</a></div>
<a name="navbar.bottom.firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../../overview-summary.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="navBarCell1Rev">Class</li>
<li><a href="class-use/StateMachine.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../index-all.html">Index</a></li>
<li><a href="../../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../../io/atomix/copycat/server/Snapshottable.html" title="interface in io.atomix.copycat.server"><span class="typeNameLink">Prev&nbsp;Class</span></a></li>
<li><a href="../../../../io/atomix/copycat/server/StateMachineContext.html" title="interface in io.atomix.copycat.server"><span class="typeNameLink">Next&nbsp;Class</span></a></li>
</ul>
<ul class="navList">
<li><a href="../../../../index.html?io/atomix/copycat/server/StateMachine.html" target="_top">Frames</a></li>
<li><a href="StateMachine.html" target="_top">No&nbsp;Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_bottom">
<li><a href="../../../../allclasses-noframe.html">All&nbsp;Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_bottom");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<div>
<ul class="subNavList">
<li>Summary:&nbsp;</li>
<li>Nested&nbsp;|&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li>Constr&nbsp;|&nbsp;</li>
<li><a href="#method.summary">Method</a></li>
</ul>
<ul class="subNavList">
<li>Detail:&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li>Constr&nbsp;|&nbsp;</li>
<li><a href="#method.detail">Method</a></li>
</ul>
</div>
<a name="skip.navbar.bottom">
<!--   -->
</a></div>
<!-- ======== END OF BOTTOM NAVBAR ======= -->
<p class="legalCopy"><small>Copyright &#169; 2013&#x2013;2015. All rights reserved.</small></p>
</body>
</html>
